name: CI

on:
  push:
    branches: [main, develop]
    tags: ['*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  metadata:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      - name: Validate manifest.json
        run: |
          if [ ! -f "manifest.json" ]; then echo "manifest.json missing"; exit 1; fi
          if [ ! -f "package.json" ]; then echo "package.json missing"; exit 1; fi
          # Validate JSON syntax
          jq . manifest.json > /dev/null
          jq . package.json > /dev/null
          # Check version consistency
          PACKAGE_VERSION=$(jq -r .version package.json)
          MANIFEST_VERSION=$(jq -r .version manifest.json)
          if [ "$PACKAGE_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "Version mismatch: package.json=$PACKAGE_VERSION, manifest.json=$MANIFEST_VERSION"
            exit 1
          fi
          echo "‚úÖ Manifest validation passed (v$PACKAGE_VERSION)"
      - name: Check manifest duplicate keys
        run: npm run check:manifest:duplicates
      - name: Check env manifest consistency
        run: npm run check:env

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      - run: npm ci
      - name: Run lint (if configured)
        run: |
          if node -e "process.exit(require('./package.json').scripts?.lint ? 0 : 1)"; then
            npm run lint
          else
            echo "‚ÑπÔ∏è No lint script found, skipping"
          fi
      - name: Check formatting (if configured)
        run: |
          if node -e "process.exit(require('./package.json').scripts?.['format:check'] ? 0 : 1)"; then
            npm run format:check
          else
            echo "‚ÑπÔ∏è No format:check script found, skipping"
          fi

  test:
    needs: [metadata, lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      - name: Install dependencies
        run: |
          START_TIME=$(date +%s)
          npm ci
          echo "INSTALL_DURATION=$(($(date +%s) - $START_TIME))" >> $GITHUB_ENV
      - name: Run tests (with coverage)
        run: |
          TEST_START=$(date +%s)
          npm run test:coverage
          echo "TEST_DURATION=$(($(date +%s) - $TEST_START))" >> $GITHUB_ENV
      - name: Report Performance Metrics
        run: |
          echo "### Performance Metrics (Node.js 20.x) üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Installation:** ${{ env.INSTALL_DURATION }}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Execution:** ${{ env.TEST_DURATION }}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Monitored Time:** $((${{ env.INSTALL_DURATION }} + ${{ env.TEST_DURATION }}))s" >> $GITHUB_STEP_SUMMARY
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('coverage/**') != ''
        with:
          name: coverage-node20
          path: coverage/
          retention-days: 7

  build:
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref_type == 'tag')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      # Ê†πÊçÆÂàÜÊîØÁ°ÆÂÆöÁõÆÊ†áÁéØÂ¢É
      # main ‚Üí prod, develop ‚Üí pre, ÂÖ∂‰ªñ ‚Üí dev
      - name: Set environment based on branch
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "infisical_env=prod" >> $GITHUB_OUTPUT
            echo "üéØ Target: Production Environment"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=pre" >> $GITHUB_OUTPUT
            echo "infisical_env=pre" >> $GITHUB_OUTPUT
            echo "üéØ Target: Pre-production Environment"
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "infisical_env=dev" >> $GITHUB_OUTPUT
            echo "üéØ Target: Development Environment"
          fi
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NODE_ENV=${{ steps.set-env.outputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  notify:
    needs: [build]
    if: always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    environment: production
    env:
      BARK_WEBHOOK_URL: ${{ secrets.BARK_WEBHOOK_URL }}
      BARK_DEVICE_TOKEN: ${{ secrets.BARK_DEVICE_TOKEN }}
    steps:
      - name: Determine target environment
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "environment_name=Áîü‰∫ßÁéØÂ¢É" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=pre" >> $GITHUB_OUTPUT
            echo "environment_name=È¢ÑÂèëÂ∏ÉÁéØÂ¢É" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "environment_name=ÂºÄÂèëÁéØÂ¢É" >> $GITHUB_OUTPUT
          fi

      - name: Notify Bark result
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            TITLE="‚úÖ GHA CI/CD ÊàêÂäü [${{ steps.set-env.outputs.environment_name }}]"
            STATUS="success"
          else
            TITLE="‚ùå GHA CI/CD Â§±Ë¥• [${{ steps.set-env.outputs.environment_name }}]"
            STATUS="failure"
          fi

          # Use printf to handle multiline content safely for JSON
          CONTENT="ÁéØÂ¢É: ${{ steps.set-env.outputs.environment_name }}\nWorkflow: ${{ github.workflow }}\nStatus: ${{ job.status }}\nCommit: ${{ github.sha }}\nRef: ${{ github.ref }}"

          # Ensure BARK_WEBHOOK_URL ends with / if it's just the domain
          BASE_URL="${{ secrets.BARK_WEBHOOK_URL }}"
          BASE_URL="${BASE_URL%/}"

          # Only send notification if secrets are configured
          if [ -n "$BASE_URL" ] && [ -n "${{ secrets.BARK_DEVICE_TOKEN }}" ]; then
            curl -L -X POST "$BASE_URL/push" \
              -H "Content-Type: application/json; charset=utf-8" \
              -d "{
                \"title\": \"$TITLE\",
                \"body\": \"$CONTENT\",
                \"device_key\": \"${{ secrets.BARK_DEVICE_TOKEN }}\",
                \"group\": \"GHA\"
              }" || echo "‚ö†Ô∏è Bark notification failed (secrets may not be configured)"
          else
            echo "‚ÑπÔ∏è Bark notification skipped (secrets not configured)"
          fi
