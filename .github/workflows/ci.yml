name: CI

on:
  push:
    branches: [main, develop]
    tags: ['*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  metadata:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate manifest.json
        run: |
          if [ ! -f "manifest.json" ]; then echo "manifest.json missing"; exit 1; fi
          if [ ! -f "package.json" ]; then echo "package.json missing"; exit 1; fi
          # Validate JSON syntax
          jq . manifest.json > /dev/null
          jq . package.json > /dev/null
          # Check version consistency
          PACKAGE_VERSION=$(jq -r .version package.json)
          MANIFEST_VERSION=$(jq -r .version manifest.json)
          if [ "$PACKAGE_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "Version mismatch: package.json=$PACKAGE_VERSION, manifest.json=$MANIFEST_VERSION"
            exit 1
          fi
          echo "‚úÖ Manifest validation passed (v$PACKAGE_VERSION)"

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      - run: npm ci
      - name: Run ESLint (if available)
        run: |
          if [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ] || [ -f "eslint.config.js" ]; then
            npm run lint || echo "‚ö†Ô∏è ESLint configured but failed"
          else
            echo "‚ÑπÔ∏è No ESLint configuration found, skipping lint check"
          fi
      - name: Check code formatting
        run: |
          if command -v prettier &> /dev/null; then
            npm run format:check || echo "‚ö†Ô∏è Prettier check failed"
          else
            echo "‚ÑπÔ∏è Prettier not configured, skipping format check"
          fi

  test:
    needs: [metadata, lint]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]
        test-type: [jest]
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-
      - name: Install dependencies
        run: |
          START_TIME=$(date +%s)
          npm ci
          echo "INSTALL_DURATION=$(($(date +%s) - $START_TIME))" >> $GITHUB_ENV
      - name: Run Tests (${{ matrix.test-type }})
        run: |
          TEST_START=$(date +%s)
          npm test -- --verbose
          echo "TEST_DURATION=$(($(date +%s) - $TEST_START))" >> $GITHUB_ENV
      - name: Report Performance Metrics
        run: |
          echo "### Performance Metrics (Node.js ${{ matrix.node-version }}) üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Installation:** ${{ env.INSTALL_DURATION }}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Execution:** ${{ env.TEST_DURATION }}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Monitored Time:** $((${{ env.INSTALL_DURATION }} + ${{ env.TEST_DURATION }}))s" >> $GITHUB_STEP_SUMMARY
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.node-version }}
          path: coverage/
          retention-days: 7

  build:
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref_type == 'tag')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      # Ê†πÊçÆÂàÜÊîØÁ°ÆÂÆöÁõÆÊ†áÁéØÂ¢É
      # main ‚Üí prod, develop ‚Üí pre, ÂÖ∂‰ªñ ‚Üí dev
      - name: Set environment based on branch
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "infisical_env=prod" >> $GITHUB_OUTPUT
            echo "üéØ Target: Production Environment"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=pre" >> $GITHUB_OUTPUT
            echo "infisical_env=pre" >> $GITHUB_OUTPUT
            echo "üéØ Target: Pre-production Environment"
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "infisical_env=dev" >> $GITHUB_OUTPUT
            echo "üéØ Target: Development Environment"
          fi

      # Áªü‰∏ÄÊñπÊ°àÔºö‰ªé Infisical ÂêåÊ≠•ÁéØÂ¢ÉÂèòÈáè
      # INFISICAL_TOKEN ‰ΩøÁî® secrets (ÊïèÊÑü‰ø°ÊÅØ)
      # INFISICAL_PROJECT_ID ‰ΩøÁî® vars (ÈùûÊïèÊÑüÈÖçÁΩÆ)
      # Ê†πÊçÆÂàÜÊîØËá™Âä®ÈÄâÊã©ÂØπÂ∫îÁöÑ Infisical ÁéØÂ¢É
      - name: Sync environment variables from Infisical
        env:
          INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}
          INFISICAL_PROJECT_ID: ${{ vars.INFISICAL_PROJECT_ID }}
          INFISICAL_ENV: ${{ steps.set-env.outputs.infisical_env }}
          INFISICAL_SECRET_PATH: /
        run: |
          echo "üîÑ Syncing from Infisical environment: $INFISICAL_ENV"
          npm run sync:env
        continue-on-error: true  # ÂÖÅËÆ∏ÈôçÁ∫ßÂà∞Êú¨Âú∞ÁºìÂ≠òÊàñ‰∫ëÈÖçÁΩÆ
      
      # Â§ÑÁêÜÁéØÂ¢ÉÂèòÈáè‰∏≠ÁöÑÂ§ö‰ΩôÂºïÂè∑ÔºàInfisical ÂèØËÉΩËøîÂõûÂ∏¶ÂºïÂè∑ÁöÑÂÄºÔºâ
      - name: Clean up quotes in environment variables
        if: success() || failure()  # Âç≥‰Ωø sync Â§±Ë¥•‰πüË¶ÅÊâßË°åÔºåÂõ†‰∏∫ÂèØËÉΩÊúâÊú¨Âú∞ .env
        run: |
          if [ -f .env ]; then
            echo "Cleaning up quotes in .env file..."
            # ÁßªÈô§ÂÄº‰∏≠ÁöÑÂ§ñÂ±ÇÂºïÂè∑ÔºàÂçïÂºïÂè∑ÊàñÂèåÂºïÂè∑Ôºâ
            sed -i 's/="\([^"]*\)"/=\1/g' .env
            sed -i "s/='\([^']*\)'/=\1/g" .env
            # ÁßªÈô§ÂÄºÂºÄÂ§¥ÂíåÁªìÂ∞æÁöÑÂºïÂè∑ÔºàÂ§ÑÁêÜÁâπÊÆäÊÉÖÂÜµÔºâ
            sed -i 's/^"\(.*\)"$/\1/' .env
            sed -i "s/^'\(.*\)'$/\1/" .env
            echo "‚úÖ Quotes cleaned up"
            # ÊòæÁ§∫ÂâçÂá†Ë°åÁî®‰∫éÈ™åËØÅ
            head -5 .env
          else
            echo "‚ÑπÔ∏è No .env file found, skipping quote cleanup"
          fi
      
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # ÂÖ≥ÈîÆÁÇπÔºöÂ∞Ü Infisical Âá≠ÊçÆÂíåÁéØÂ¢ÉÂèòÈáè‰º†ÈÄíÁªô Docker ÊûÑÂª∫ËøáÁ®ã
          # ËøôÊ†∑ Dockerfile ÂÜÖÈÉ®ÁöÑ sync-env.js ÊâçËÉΩËé∑ÂèñÂèòÈáè
          build-args: |
            INFISICAL_TOKEN=${{ secrets.INFISICAL_TOKEN }}
            INFISICAL_PROJECT_ID=${{ vars.INFISICAL_PROJECT_ID }}
            NODE_ENV=${{ steps.set-env.outputs.environment }}
            INFISICAL_ENV=${{ steps.set-env.outputs.infisical_env }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  notify:
    needs: [build]
    if: always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    environment: production
    env:
      BARK_WEBHOOK_URL: ${{ secrets.BARK_WEBHOOK_URL }}
      BARK_DEVICE_TOKEN: ${{ secrets.BARK_DEVICE_TOKEN }}
    steps:
      - name: Determine target environment
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "environment_name=Áîü‰∫ßÁéØÂ¢É" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=pre" >> $GITHUB_OUTPUT
            echo "environment_name=È¢ÑÂèëÂ∏ÉÁéØÂ¢É" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "environment_name=ÂºÄÂèëÁéØÂ¢É" >> $GITHUB_OUTPUT
          fi

      - name: Notify Bark result
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            TITLE="‚úÖ GHA CI/CD ÊàêÂäü [${{ steps.set-env.outputs.environment_name }}]"
            STATUS="success"
          else
            TITLE="‚ùå GHA CI/CD Â§±Ë¥• [${{ steps.set-env.outputs.environment_name }}]"
            STATUS="failure"
          fi

          # Use printf to handle multiline content safely for JSON
          CONTENT="ÁéØÂ¢É: ${{ steps.set-env.outputs.environment_name }}\nWorkflow: ${{ github.workflow }}\nStatus: ${{ job.status }}\nCommit: ${{ github.sha }}\nRef: ${{ github.ref }}"

          # Ensure BARK_WEBHOOK_URL ends with / if it's just the domain
          BASE_URL="${{ secrets.BARK_WEBHOOK_URL }}"
          BASE_URL="${BASE_URL%/}"

          # Only send notification if secrets are configured
          if [ -n "$BASE_URL" ] && [ -n "${{ secrets.BARK_DEVICE_TOKEN }}" ]; then
            curl -L -X POST "$BASE_URL/push" \
              -H "Content-Type: application/json; charset=utf-8" \
              -d "{
                \"title\": \"$TITLE\",
                \"body\": \"$CONTENT\",
                \"device_key\": \"${{ secrets.BARK_DEVICE_TOKEN }}\",
                \"group\": \"GHA\"
              }" || echo "‚ö†Ô∏è Bark notification failed (secrets may not be configured)"
          else
            echo "‚ÑπÔ∏è Bark notification skipped (secrets not configured)"
          fi