{
  "manifest_version": "1.1",
  "id": "drive-collector-js",
  "name": "Drive Collector Bot",
  "version": "4.19.0",
  "description": "基于 JSON Schema 契约中心的分布式转存项目，支持 Telegram 媒体转存至 Rclone/S3。",
  "type": "worker",
  "capabilities": [
    "telegram-bot",
    "distributed-task-scheduling",
    "multi-instance-locking",
    "instance-registration",
    "qstash-webhook",
    "d1-storage",
    "cache-failover",
    "rclone-integration",
    "s3-transfer",
    "sec-transfer",
    "diagnosis-reporting"
  ],
  "behaviors": {
    "telegramHandler": {
      "description": "处理 Telegram 消息与回调，包含去重、权限校验与媒体聚合",
      "input": "telegram-mtproto",
      "inputSchema": {
        "type": "object",
        "properties": {
          "update": {
            "type": "object",
            "description": "Telegram Update 对象",
            "properties": {
              "update_id": {
                "type": "number"
              },
              "message": {
                "type": "object"
              },
              "callback_query": {
                "type": "object"
              }
            }
          }
        },
        "required": [
          "update"
        ]
      },
      "locking": {
        "mechanism": "cache",
        "pattern": "msg_lock:{msgId}",
        "ttl": 60,
        "description": "基于消息 ID 的去重锁，防止重复处理"
      },
      "dependencies": [
        "AuthGuard",
        "SessionManager",
        "InstanceCoordinator"
      ],
      "reliability": {
        "timeout": 30,
        "errorHandling": "graceful-degradation",
        "fallback": "skip-duplicate"
      }
    },
    "taskProcessor": {
      "description": "基于 QStash Webhook 的分布式任务处理器",
      "input": "qstash-webhook",
      "inputSchema": {
        "type": "object",
        "properties": {
          "taskId": {
            "type": "string"
          },
          "groupId": {
            "type": "string"
          },
          "taskIds": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "type": {
            "type": "string",
            "enum": [
              "download",
              "upload",
              "batch",
              "system-event"
            ]
          },
          "event": {
            "type": "string"
          },
          "payload": {
            "type": "object"
          },
          "timestamp": {
            "type": "number"
          }
        },
        "required": [
          "type"
        ]
      },
      "endpoints": {
        "health": "/health",
        "healthz": "/healthz",
        "ready": "/ready",
        "webhookBase": "/api/tasks",
        "download": "/api/tasks/download",
        "upload": "/api/tasks/upload",
        "batch": "/api/tasks/batch",
        "systemEvents": "/api/tasks/system-events"
      },
      "locking": {
        "mechanism": "cache",
        "pattern": "task:{taskId}",
        "ttl": 600,
        "description": "任务级分布式锁，支持故障转移后的延迟恢复"
      },
      "dependencies": [
        "TaskManager",
        "QStashService",
        "D1",
        "Cache",
        "InstanceCoordinator"
      ],
      "reliability": {
        "retry": "qstash-default",
        "failover": "delayed-recovery-on-cache-error",
        "maxRetries": 3,
        "timeout": 300
      }
    },
    "storageUploader": {
      "description": "三轨制存储上传器 (Worker -> S3 -> Rclone)",
      "input": "local-file",
      "inputSchema": {
        "type": "object",
        "properties": {
          "filePath": {
            "type": "string"
          },
          "fileId": {
            "type": "string"
          },
          "size": {
            "type": "number"
          },
          "hash": {
            "type": "string"
          }
        },
        "required": [
          "filePath",
          "fileId"
        ]
      },
      "outputs": [
        "rclone",
        "s3"
      ],
      "features": [
        "sec-transfer",
        "dynamic-cache-ttl",
        "integrity-verification"
      ],
      "locking": {
        "mechanism": "local-mutex",
        "description": "本地文件上传互斥锁，防止并发上传同一文件"
      },
      "dependencies": [
        "CloudTool (rclone)",
        "OSSService",
        "ossHelper"
      ],
      "reliability": {
        "secTransfer": {
          "enabled": true,
          "description": "秒传校验，基于文件哈希快速验证存在性"
        },
        "cacheStrategy": {
          "ttl": "dynamic",
          "basis": "file-access-frequency"
        },
        "integrityCheck": "sha256"
      }
    },
    "instanceCoordinator": {
      "description": "多实例协调器，负责注册、心跳、领导者选举与分布式锁管理",
      "input": "internal-timer",
      "inputSchema": {
        "type": "object",
        "properties": {
          "action": {
            "type": "string",
            "enum": [
              "register",
              "heartbeat",
              "leader-check",
              "cleanup"
            ]
          }
        }
      },
      "locking": {
        "mechanism": "cache-atomic",
        "patterns": [
          "instance:{instanceId}",
          "lock:{lockKey}",
          "task:{taskId}"
        ],
        "ttl": 900,
        "description": "基于 Cache 的原子操作实现分布式锁，支持锁续约与自动过期"
      },
      "dependencies": [
        "CacheService"
      ],
      "reliability": {
        "heartbeatInterval": 300,
        "timeout": 900,
        "cleanupInterval": 300,
        "leaderElection": {
          "strategy": "minimum-id",
          "description": "所有活跃实例按 ID 字典序排序，排名第一的实例自动成为 Leader"
        }
      }
    },
    "driveRepository": {
      "description": "网盘配置存储库，支持活跃网盘列表管理",
      "input": "cache-storage",
      "features": [
        "active-drives-list",
        "drive-id-lookup"
      ],
      "reliability": {
        "cacheStrategy": "cache-with-json",
        "errorHandling": "graceful-degradation",
        "fallback": "empty-array"
      },
      "dependencies": [
        "CacheService"
      ]
    }
  },
  "instanceRegistration": {
    "mechanism": "Distributed Cache (Redis/KV/Upstash)",
    "heartbeatInterval": 300,
    "timeout": 900,
    "keys": [
      {
        "pattern": "instance:{instanceId}",
        "description": "实例元数据"
      },
      {
        "pattern": "lock:{lockKey}",
        "description": "分布式锁"
      },
      {
        "pattern": "task:{taskId}",
        "description": "任务锁"
      },
      {
        "pattern": "msg_lock:{msgId}",
        "description": "消息去重锁"
      }
    ],
    "locking": {
      "mechanism": "cache-atomic",
      "operations": {
        "acquire": "get-skip-cache-then-set-with-ttl",
        "release": "delete",
        "renew": "update-ttl"
      },
      "conflictResolution": "last-write-wins-with-verify-read",
      "description": "基于 Cache 的原子操作实现分布式锁，支持锁续约、自动过期与写后校验"
    },
    "valueSchema": {
      "instance": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "url": {
            "type": "string"
          },
          "hostname": {
            "type": "string"
          },
          "region": {
            "type": "string"
          },
          "startedAt": {
            "type": "number"
          },
          "lastHeartbeat": {
            "type": "number"
          },
          "status": {
            "type": "string",
            "enum": [
              "active",
              "offline"
            ]
          }
        },
        "required": [
          "id",
          "hostname",
          "startedAt",
          "lastHeartbeat",
          "status"
        ]
      },
      "lock": {
        "type": "object",
        "properties": {
          "instanceId": {
            "type": "string"
          },
          "acquiredAt": {
            "type": "number"
          },
          "ttl": {
            "type": "number"
          }
        },
        "required": [
          "instanceId",
          "acquiredAt",
          "ttl"
        ]
      }
    },
    "leaderElection": {
      "strategy": "minimum-id",
      "description": "所有活跃实例按 ID 字典序排序，排名第一的实例自动成为 Leader",
      "leaderResponsibilities": [
        "cleanup-expired-instances",
        "monitor-distributed-locks",
        "coordinator-health-check"
      ]
    },
    "reliability": {
      "cleanupInterval": 300,
      "maxLockHoldTime": 1800,
      "lockRenewalThreshold": 0.7,
      "failoverStrategy": "immediate-reacquire-on-timeout"
    }
  },
  "entrypoint": "index.js",
  "runtime": {
    "type": "nodejs",
    "version": "nodejs20"
  },
  "config": {
    "env": {
      "API_ID": {
        "type": "number",
        "required": true,
        "description": "Telegram API ID"
      },
      "API_HASH": {
        "type": "string",
        "required": true,
        "description": "Telegram API Hash",
        "sensitive": true,
        "configPaths": [
          "apiHash"
        ]
      },
      "BOT_TOKEN": {
        "type": "string",
        "required": true,
        "description": "Telegram Bot Token",
        "sensitive": true,
        "configPaths": [
          "botToken"
        ]
      },
      "OWNER_ID": {
        "type": "string",
        "required": true,
        "description": "Admin User ID"
      },
      "NODE_ENV": {
        "type": "string",
        "required": false,
        "description": "Node.js runtime environment (dev/pre/prod/test). Supports both full names (development/production/staging) and abbreviations. Defaults to dev."
      },
      "NODE_MODE": {
        "type": "string",
        "required": false,
        "description": "Application mode (bot/dev/etc.)"
      },
      "APP_VERSION": {
        "type": "string",
        "required": false,
        "description": "Application version override for logging"
      },
      "INSTANCE_ID": {
        "type": "string",
        "required": false,
        "description": "Instance ID override for multi-instance coordination"
      },
      "APP_EXTERNAL_URL": {
        "type": "string",
        "required": false,
        "description": "External URL for load balancer routing"
      },
      "HOSTNAME": {
        "type": "string",
        "required": false,
        "description": "Hostname identifier for instance metadata"
      },
      "INSTANCE_REGION": {
        "type": "string",
        "required": false,
        "description": "Instance region identifier for instance metadata"
      },
      "QSTASH_TOKEN": {
        "type": "string",
        "required": true,
        "description": "Upstash QStash Token",
        "sensitive": true,
        "configPaths": [
          "token"
        ]
      },
      "QSTASH_AUTH_TOKEN": {
        "type": "string",
        "required": false,
        "description": "Upstash QStash auth token (legacy publishing token)",
        "sensitive": true,
        "configPaths": [
          "token"
        ]
      },
      "QSTASH_URL": {
        "type": "string",
        "required": true,
        "description": "QStash API 地址"
      },
      "QSTASH_CURRENT_SIGNING_KEY": {
        "type": "string",
        "required": false,
        "description": "QStash Webhook current signing key",
        "sensitive": true,
        "configPaths": [
          "currentSigningKey"
        ]
      },
      "QSTASH_NEXT_SIGNING_KEY": {
        "type": "string",
        "required": false,
        "description": "QStash Webhook next signing key",
        "sensitive": true,
        "configPaths": [
          "nextSigningKey"
        ]
      },
      "LB_WEBHOOK_URL": {
        "type": "string",
        "required": true,
        "description": "Webhook callback URL for QStash"
      },
      "RCLONE_REMOTE": {
        "type": "string",
        "default": "mega",
        "description": "Rclone 远程名称"
      },
      "REMOTE_FOLDER": {
        "type": "string",
        "default": "/DriveCollectorBot",
        "description": "远程存储目录"
      },
      "RCLONE_CONF_BASE64": {
        "type": "string",
        "required": false,
        "description": "Rclone 配置文件的 Base64 编码"
      },
      "OSS_WORKER_URL": {
        "type": "string",
        "required": false,
        "description": "OSS Worker URL for object storage operations"
      },
      "OSS_WORKER_SECRET": {
        "type": "string",
        "required": false,
        "description": "OSS Worker secret for authentication",
        "sensitive": true,
        "configPaths": [
          "workerSecret"
        ]
      },
      "R2_ENDPOINT": {
        "type": "string",
        "required": false,
        "description": "Cloudflare R2 endpoint"
      },
      "R2_ACCESS_KEY_ID": {
        "type": "string",
        "required": false,
        "description": "Cloudflare R2 access key ID",
        "sensitive": true,
        "configPaths": [
          "accessKeyId"
        ]
      },
      "R2_SECRET_ACCESS_KEY": {
        "type": "string",
        "required": false,
        "description": "Cloudflare R2 secret access key",
        "sensitive": true,
        "configPaths": [
          "secretAccessKey"
        ]
      },
      "R2_BUCKET": {
        "type": "string",
        "required": false,
        "description": "Cloudflare R2 bucket name"
      },
      "R2_PUBLIC_URL": {
        "type": "string",
        "required": false,
        "description": "Cloudflare R2 public URL"
      },
      "AXIOM_TOKEN": {
        "type": "string",
        "required": false,
        "description": "Axiom 日志令牌"
      },
      "AXIOM_ORG_ID": {
        "type": "string",
        "required": false,
        "description": "Axiom organization ID"
      },
      "AXIOM_DATASET": {
        "type": "string",
        "required": false,
        "description": "Axiom dataset name"
      },
      "CF_D1_ACCOUNT_ID": {
        "type": "string",
        "required": false,
        "description": "Cloudflare D1 account ID"
      },
      "CF_D1_DATABASE_ID": {
        "type": "string",
        "required": false,
        "description": "Cloudflare D1 database ID"
      },
      "CF_D1_TOKEN": {
        "type": "string",
        "required": false,
        "description": "Cloudflare D1 API token"
      },
      "CF_ACCOUNT_ID": {
        "type": "string",
        "required": false,
        "description": "Cloudflare account ID (fallback for KV/D1)"
      },
      "NF_REDIS_URL": {
        "type": "string",
        "required": false,
        "description": "Northflank Redis URL (priority over legacy REDIS_URL)"
      },
      "NF_REDIS_HOST": {
        "type": "string",
        "required": false,
        "description": "Northflank Redis host"
      },
      "NF_REDIS_PORT": {
        "type": "number",
        "default": 6379,
        "description": "Northflank Redis port"
      },
      "NF_REDIS_PASSWORD": {
        "type": "string",
        "required": false,
        "description": "Northflank Redis password"
      },
      "REDIS_TOKEN": {
        "type": "string",
        "required": false,
        "description": "General Redis authentication token (used if password is not provided in URL or other variables)"
      },
      "REDIS_URL": {
        "type": "string",
        "required": false,
        "description": "Legacy Redis URL (deprecated, use NF_REDIS_URL)"
      },
      "REDIS_HOST": {
        "type": "string",
        "required": false,
        "description": "Legacy Redis host (deprecated, use NF_REDIS_HOST)"
      },
      "REDIS_PORT": {
        "type": "number",
        "default": 6379,
        "description": "Legacy Redis port (deprecated, use NF_REDIS_PORT)"
      },
      "REDIS_PASSWORD": {
        "type": "string",
        "required": false,
        "description": "Legacy Redis password (deprecated, use NF_REDIS_PASSWORD)"
      },
      "REDIS_MAX_RETRIES": {
        "type": "number",
        "default": 5,
        "description": "Maximum number of Redis connection retry attempts before failing"
      },
      "REDIS_RESTART_DELAY": {
        "type": "number",
        "default": 5000,
        "description": "Delay in milliseconds before restarting Redis client after connection loss"
      },
      "REDIS_TLS_ENABLED": {
        "type": "boolean",
        "default": false,
        "description": "启用 Redis TLS"
      },
      "REDIS_TLS_REJECT_UNAUTHORIZED": {
        "type": "boolean",
        "default": true,
        "description": "TLS 证书严格验证"
      },
      "REDIS_TLS_CA": {
        "type": "string",
        "required": false,
        "description": "CA 证书 (Base64)"
      },
      "REDIS_TLS_CLIENT_CERT": {
        "type": "string",
        "required": false,
        "description": "客户端证书 (Base64)"
      },
      "REDIS_TLS_CLIENT_KEY": {
        "type": "string",
        "required": false,
        "description": "客户端私钥 (Base64)"
      },
      "REDIS_SNI_SERVERNAME": {
        "type": "string",
        "required": false,
        "description": "TLS SNI 主机名"
      },
      "NF_REDIS_TLS_ENABLED": {
        "type": "boolean",
        "default": false,
        "description": "Northflank Redis TLS 启用开关"
      },
      "NF_REDIS_TLS_REJECT_UNAUTHORIZED": {
        "type": "boolean",
        "default": true,
        "description": "Northflank Redis TLS 证书严格验证"
      },
      "NF_REDIS_TLS_CA": {
        "type": "string",
        "required": false,
        "description": "Northflank Redis TLS CA 证书 (Base64)"
      },
      "NF_REDIS_TLS_CLIENT_CERT": {
        "type": "string",
        "required": false,
        "description": "Northflank Redis TLS 客户端证书 (Base64)"
      },
      "NF_REDIS_TLS_CLIENT_KEY": {
        "type": "string",
        "required": false,
        "description": "Northflank Redis TLS 客户端私钥 (Base64)"
      },
      "NF_REDIS_SNI_SERVERNAME": {
        "type": "string",
        "required": false,
        "description": "Northflank Redis TLS SNI 主机名"
      },
      "CACHE_PROVIDER": {
        "type": "string",
        "required": false,
        "enum": [
          "redis",
          "cloudflare",
          "upstash"
        ],
        "description": "强制指定缓存提供商 (优先级高于自动检测)"
      },
      "KV_PROVIDER": {
        "type": "string",
        "required": false,
        "enum": [
          "redis",
          "cloudflare",
          "upstash"
        ],
        "description": "Legacy 缓存提供商指定 (建议使用 CACHE_PROVIDER)"
      },
      "CF_CACHE_ACCOUNT_ID": {
        "type": "string",
        "required": false,
        "description": "Cloudflare Cache account ID (also supports CF_KV_ACCOUNT_ID for backward compatibility)"
      },
      "CF_CACHE_NAMESPACE_ID": {
        "type": "string",
        "required": false,
        "description": "Cloudflare Cache namespace ID (also supports CF_KV_NAMESPACE_ID for backward compatibility)"
      },
      "CF_CACHE_TOKEN": {
        "type": "string",
        "required": false,
        "description": "Cloudflare Cache API token (also supports CF_KV_TOKEN for backward compatibility)"
      },
      "CF_KV_ACCOUNT_ID": {
        "type": "string",
        "required": false,
        "description": "Legacy Cloudflare KV account ID (deprecated, use CF_CACHE_ACCOUNT_ID)"
      },
      "CF_KV_NAMESPACE_ID": {
        "type": "string",
        "required": false,
        "description": "Legacy Cloudflare KV namespace ID (deprecated, use CF_CACHE_NAMESPACE_ID)"
      },
      "CF_KV_TOKEN": {
        "type": "string",
        "required": false,
        "description": "Legacy Cloudflare KV API token (deprecated, use CF_CACHE_TOKEN)"
      },
      "UPSTASH_REDIS_REST_URL": {
        "type": "string",
        "required": false,
        "description": "Upstash Redis REST API URL"
      },
      "UPSTASH_REDIS_REST_TOKEN": {
        "type": "string",
        "required": false,
        "description": "Upstash Redis REST API token"
      },
      "PORT": {
        "type": "number",
        "default": 8080,
        "description": "Server port for webhooks"
      },
      "TELEGRAM_PROXY_HOST": {
        "type": "string",
        "required": false,
        "description": "Telegram 代理服务器地址"
      },
      "TELEGRAM_PROXY_PORT": {
        "type": "number",
        "required": false,
        "description": "Telegram 代理服务器端口"
      },
      "TELEGRAM_PROXY_TYPE": {
        "type": "string",
        "required": false,
        "enum": [
          "socks4",
          "socks5"
        ],
        "default": "socks5",
        "description": "Telegram 代理类型，支持 socks4 和 socks5"
      },
      "TELEGRAM_PROXY_USERNAME": {
        "type": "string",
        "required": false,
        "description": "Telegram 代理服务器用户名"
      },
      "TELEGRAM_PROXY_PASSWORD": {
        "type": "string",
        "required": false,
        "description": "Telegram 代理服务器密码"
      },
      "TG_DEVICE_MODEL": {
        "type": "string",
        "required": false,
        "description": "Telegram client device model"
      },
      "TG_SYSTEM_VERSION": {
        "type": "string",
        "required": false,
        "description": "Telegram client system version"
      },
      "TG_APP_VERSION": {
        "type": "string",
        "required": false,
        "description": "Telegram client app version"
      },
      "TG_TEST_MODE": {
        "type": "boolean",
        "required": false,
        "description": "Enable Telegram test mode"
      },
      "TG_SERVER_DC": {
        "type": "number",
        "required": false,
        "description": "Telegram DC override (requires TG_SERVER_IP and TG_SERVER_PORT)"
      },
      "TG_SERVER_IP": {
        "type": "string",
        "required": false,
        "description": "Telegram server IP override (requires TG_SERVER_DC and TG_SERVER_PORT)"
      },
      "TG_SERVER_PORT": {
        "type": "number",
        "required": false,
        "description": "Telegram server port override (requires TG_SERVER_DC and TG_SERVER_IP)"
      },
      "TG_PROXY_HOST": {
        "type": "string",
        "required": false,
        "description": "Telegram proxy host (TG_* alias)"
      },
      "TG_PROXY_PORT": {
        "type": "number",
        "required": false,
        "description": "Telegram proxy port (TG_* alias)"
      },
      "TG_PROXY_TYPE": {
        "type": "string",
        "required": false,
        "enum": [
          "socks4",
          "socks5"
        ],
        "description": "Telegram proxy type (TG_* alias)"
      },
      "TG_PROXY_USERNAME": {
        "type": "string",
        "required": false,
        "description": "Telegram proxy username (TG_* alias)"
      },
      "TG_PROXY_PASSWORD": {
        "type": "string",
        "required": false,
        "description": "Telegram proxy password (TG_* alias)"
      },
      "CACHE_PROVIDERS": {
        "type": "string",
        "required": false,
        "description": "JSON 格式的缓存提供者配置数组，支持优先级和多实例配置。例如: [{\"type\":\"valkey\",\"priority\":1,\"host\":\"...\",\"port\":6379,\"name\":\"primary\"}]"
      },
      "PRIMARY_CACHE_PROVIDER": {
        "type": "string",
        "required": false,
        "description": "强制指定某个配置的 name 作为主缓存提供者，用于覆盖优先级或故障转移后的选择"
      },
      "VALKEY_HOST": {
        "type": "string",
        "required": false,
        "description": "Valkey 数据库主机地址 (自动检测为 Valkey 提供者)"
      },
      "VALKEY_PORT": {
        "type": "number",
        "default": 6379,
        "description": "Valkey 数据库端口"
      },
      "VALKEY_URL": {
        "type": "string",
        "required": false,
        "description": "Valkey 完整连接 URL (支持 redis:// 或 valkeys://)"
      },
      "VALKEY_PASSWORD": {
        "type": "string",
        "required": false,
        "description": "Valkey 数据库密码",
        "sensitive": true,
        "configPaths": [
          "password"
        ]
      },
      "VALKEY_USER": {
        "type": "string",
        "required": false,
        "description": "Valkey 数据库用户名 (Aiven)"
      },
      "VALKEY_CA_CERT": {
        "type": "string",
        "required": false,
        "description": "Valkey CA 证书 (Aiven)"
      },
      "VALKEY_TLS": {
        "type": "boolean",
        "default": false,
        "description": "启用 Valkey TLS 连接"
      },
      "VALKEY_DB": {
        "type": "number",
        "default": 0,
        "description": "Valkey 数据库索引"
      },
      "INFISICAL_CLIENT_ID": {
        "type": "string",
        "required": false,
        "description": "Infisical client ID"
      },
      "INFISICAL_CLIENT_SECRET": {
        "type": "string",
        "required": false,
        "description": "Infisical client secret",
        "sensitive": true,
        "configPaths": [
          "clientSecret"
        ]
      },
      "INFISICAL_TOKEN": {
        "type": "string",
        "required": false,
        "description": "Infisical access token",
        "sensitive": true,
        "configPaths": [
          "token"
        ]
      },
      "INFISICAL_PROJECT_ID": {
        "type": "string",
        "required": false,
        "description": "Infisical project ID"
      },
      "INFISICAL_ENV": {
        "type": "string",
        "required": false,
        "description": "Infisical environment name"
      },
      "INFISICAL_SECRET_PATH": {
        "type": "string",
        "required": false,
        "description": "Infisical secret path"
      },
      "STRICT_SYNC": {
        "type": "boolean",
        "required": false,
        "description": "Infisical sync strict mode"
      },
      "SKIP_INFISICAL_RUNTIME": {
        "type": "boolean",
        "required": false,
        "description": "Skip Infisical runtime fetch"
      }
    }
  },
  "endpoints": {
    "health": "/health",
    "healthz": "/healthz",
    "ready": "/ready",
    "webhookBase": "/api/tasks",
    "download": "/api/tasks/download",
    "upload": "/api/tasks/upload",
    "batch": "/api/tasks/batch",
    "systemEvents": "/api/tasks/system-events"
  }
}
