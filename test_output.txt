
> drive-collector-bot@2.0.0 test
> node --experimental-vm-modules node_modules/jest/bin/jest.js

(node:37860) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS __tests__/modules/SessionManager.test.js
(node:41268) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS __tests__/services/kv.test.js
(node:8668) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS __tests__/locales/zh-CN.test.js
(node:48596) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS __tests__/config/index.test.js
(node:50452) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS __tests__/services/d1.test.js
(node:3164) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL __tests__/repositories/TaskRepository.cache.test.js
  鈼?Test suite failed to run

    TypeError: Cannot redefine property: Symbol($$jest-matchers-object)
        at Object.defineProperty (<anonymous>)

      at node_modules/@vitest/expect/dist/index.js:680:9

(node:49868) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL __tests__/utils/CacheService.test.js
  鈼?Test suite failed to run

    TypeError: Cannot redefine property: Symbol($$jest-matchers-object)
        at Object.defineProperty (<anonymous>)

      at node_modules/@vitest/expect/dist/index.js:680:9

(node:9580) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL __tests__/utils/limiter.test.js
  鈼?Test suite failed to run

    TypeError: Cannot redefine property: Symbol($$jest-matchers-object)
        at Object.defineProperty (<anonymous>)

      at node_modules/@vitest/expect/dist/index.js:680:9

(node:41908) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL __tests__/services/rclone.test.js
  鈼?Console

    console.error
      Obscure non-zero exit: error

      53 |             }
      54 |             if (ret.status !== 0) {
    > 55 |                 console.error("Obscure non-zero exit:", ret.stderr);
         |                         ^
      56 |                 return password;
      57 |             }
      58 |             

      at CloudTool._obscure (src/services/rclone.js:55:25)
      at Object.<anonymous> (__tests__/services/rclone.test.js:97:38)

    console.error
      Obscure spawn error: Error: spawn error
          at Object.<anonymous> (C:\Users\shang\Project\drive-collector-js\__tests__\services\rclone.test.js:103:24)
          at Promise.then.completed (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:103:5)
          at _runTest (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\shang\Project\drive-collector-js\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\shang\Project\drive-collector-js\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\shang\Project\drive-collector-js\node_modules\jest-runner\build\testWorker.js:106:12)

      49 |             
      50 |             if (ret.error) {
    > 51 |                 console.error("Obscure spawn error:", ret.error);
         |                         ^
      52 |                 return password;
      53 |             }
      54 |             if (ret.status !== 0) {

      at CloudTool._obscure (src/services/rclone.js:51:25)
      at Object.<anonymous> (__tests__/services/rclone.test.js:106:38)

    console.error
      Obscure spawn error: Error: spawn error
          at Object.<anonymous> (C:\Users\shang\Project\drive-collector-js\__tests__\services\rclone.test.js:103:24)
          at Promise.then.completed (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:103:5)
          at _runTest (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\shang\Project\drive-collector-js\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\shang\Project\drive-collector-js\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\shang\Project\drive-collector-js\node_modules\jest-runner\build\testWorker.js:106:12)

      49 |             
      50 |             if (ret.error) {
    > 51 |                 console.error("Obscure spawn error:", ret.error);
         |                         ^
      52 |                 return password;
      53 |             }
      54 |             if (ret.status !== 0) {

      at CloudTool._obscure (src/services/rclone.js:51:25)
      at src/services/rclone.js:83:44
      at CloudTool.validateConfig (src/services/rclone.js:79:16)
      at Object.<anonymous> (__tests__/services/rclone.test.js:117:39)

    console.error
      Obscure spawn error: Error: spawn error
          at Object.<anonymous> (C:\Users\shang\Project\drive-collector-js\__tests__\services\rclone.test.js:103:24)
          at Promise.then.completed (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:103:5)
          at _runTest (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\shang\Project\drive-collector-js\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\shang\Project\drive-collector-js\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\shang\Project\drive-collector-js\node_modules\jest-runner\build\testWorker.js:106:12)

      49 |             
      50 |             if (ret.error) {
    > 51 |                 console.error("Obscure spawn error:", ret.error);
         |                         ^
      52 |                 return password;
      53 |             }
      54 |             if (ret.status !== 0) {

      at CloudTool._obscure (src/services/rclone.js:51:25)
      at src/services/rclone.js:83:44
      at CloudTool.validateConfig (src/services/rclone.js:79:16)
      at Object.<anonymous> (__tests__/services/rclone.test.js:132:39)

    console.error
      Obscure spawn error: Error: spawn error
          at Object.<anonymous> (C:\Users\shang\Project\drive-collector-js\__tests__\services\rclone.test.js:103:24)
          at Promise.then.completed (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:103:5)
          at _runTest (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\shang\Project\drive-collector-js\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\shang\Project\drive-collector-js\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\shang\Project\drive-collector-js\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\shang\Project\drive-collector-js\node_modules\jest-runner\build\testWorker.js:106:12)

      49 |             
      50 |             if (ret.error) {
    > 51 |                 console.error("Obscure spawn error:", ret.error);
         |                         ^
      52 |                 return password;
      53 |             }
      54 |             if (ret.status !== 0) {

      at CloudTool._obscure (src/services/rclone.js:51:25)
      at src/services/rclone.js:83:44
      at CloudTool.validateConfig (src/services/rclone.js:79:16)
      at Object.<anonymous> (__tests__/services/rclone.test.js:149:44)

    console.error
      Rclone Error (Task undefined): Upload failed because of disk full

      151 |                     } else {
      152 |                         const finalError = errorLog.slice(-500) || `Rclone exited with code ${code}`;
    > 153 |                         console.error(`Rclone Error (Task ${task.id}):`, finalError);
          |                                 ^
      154 |                         resolve({ success: false, error: finalError.trim() });
      155 |                     }
      156 |                 });

      at EventEmitter.<anonymous> (src/services/rclone.js:153:33)
      at Timeout._onTimeout (__tests__/services/rclone.test.js:192:26)

  鈼?CloudTool 鈥?listRemoteFiles 鈥?should return files and cache them

    expect(received).toBeDefined()

    Received: undefined

      236 |             const files = await CloudTool.listRemoteFiles('user123');
      237 |             expect(files).toEqual(mockFiles);
    > 238 |             expect(CloudTool.cache['files_user123']).toBeDefined();
          |                                                      ^
      239 |             
      240 |             // Second call should use cache
      241 |             await CloudTool.listRemoteFiles('user123');

      at Object.<anonymous> (__tests__/services/rclone.test.js:238:54)

  鈼?CloudTool 鈥?listRemoteFiles 鈥?should force refresh when requested

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 2
    Received number of calls: 1

      252 |             await CloudTool.listRemoteFiles('user123');
      253 |             await CloudTool.listRemoteFiles('user123', true);
    > 254 |             expect(mockSpawnSync).toHaveBeenCalledTimes(2);
          |                                   ^
      255 |         });
      256 |
      257 |         it('should handle rclone error and return empty array', async () => {

      at Object.<anonymous> (__tests__/services/rclone.test.js:254:35)

(node:44628) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS __tests__/services/telegram.test.js
FAIL __tests__/bot/Dispatcher.test.js
  鈼?Test suite failed to run

    SyntaxError: The requested module '../utils/common.js' does not provide an export named 'escapeHTML'

      123 |
      124 | // Load Dispatcher
    > 125 | const { Dispatcher } = await import("../../src/bot/Dispatcher.js");
          |                        ^
      126 |
      127 | describe("Dispatcher", () => {
      128 |   beforeEach(() => {

      at Runtime.linkAndEvaluateModule (node_modules/jest-runtime/build/index.js:708:5)
      at __tests__/bot/Dispatcher.test.js:125:24

(node:26644) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL __tests__/core/TaskManager.test.js
  鈼?Test suite failed to run

    SyntaxError: The requested module '../utils/limiter.js' does not provide an export named 'PRIORITY'

      121 |
      122 | // 瀵煎叆 TaskManager
    > 123 | const { TaskManager } = await import("../../src/core/TaskManager.js");
          |                         ^
      124 | const { updateStatus } = await import("../../src/utils/common.js");
      125 |
      126 | describe("TaskManager", () => {

      at Runtime.linkAndEvaluateModule (node_modules/jest-runtime/build/index.js:708:5)
      at __tests__/core/TaskManager.test.js:123:25

(node:2016) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:48000) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS __tests__/modules/DriveConfigFlow.test.js
(node:46456) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL __tests__/ui.test.js
  鈼?UIHelper 鈥?renderFilesPage 鈥?renders first page correctly

    expect(received).toContain(expected) // indexOf

    Expected substring: "馃帪锔?<b>file1.mp4</b>
    > <code>100.00 MB</code> | <code>2023-01-01 12:00</code>"
    Received string:    "馃搨 <b>鐩綍</b>: <code>/DriveCollectorBot</code>路
    馃帪锔?<b>file1.mp4</b>
        <code>100.00 MB</code> | <code>2023-01-01 12:00</code>路
    馃摑 <b>document.pdf</b>
        <code>5.00 MB</code> | <code>2023-01-02 13:00</code>路
    馃摝 <b>archive.zip</b>
        <code>1000.00 MB</code> | <code>2023-01-03 14:00</code>路
    馃柤锔?<b>image.jpg</b>
        <code>2.00 MB</code> | <code>2023-01-04 15:00</code>路
    馃帪锔?<b>video.mkv</b>
        <code>200.00 MB</code> | <code>2023-01-05 16:00</code>路
    馃帪锔?<b>another.mp4</b>
        <code>300.00 MB</code> | <code>2023-01-06 17:00</code>路
    鈳幆鈳幆鈳幆鈳幆鈳幆鈳幆鈳幆鈳幆鈳?    馃搳 <i>绗?1/2 椤?| 鍏?7 涓枃浠?/i>"

      119 |
      120 |       expect(text).toContain("馃搨 <b>鐩綍</b>: <code>/DriveCollectorBot</code>");
    > 121 |       expect(text).toContain('馃帪锔?<b>file1.mp4</b>\n> <code>100.00 MB</code> | <code>2023-01-01 12:00</code>');
          |                    ^
      122 |       expect(text).toContain("馃搳 <i>绗?1/2 椤?| 鍏?7 涓枃浠?/i>");
      123 |       expect(buttons[0][0].text).toBe(' '); // Home button disabled
      124 |       expect(buttons[0][1].text).toBe(' '); // Prev button disabled

      at Object.<anonymous> (__tests__/ui.test.js:121:20)

  鈼?UIHelper 鈥?renderFilesPage 鈥?renders second page correctly

    expect(received).toContain(expected) // indexOf

    Expected substring: "馃搫 <b>last.txt</b>
    > <code>0.00 MB</code> | <code>2023-01-07 18:00</code>"
    Received string:    "馃搨 <b>鐩綍</b>: <code>/DriveCollectorBot</code>路
    馃搫 <b>last.txt</b>
        <code>0.00 MB</code> | <code>2023-01-07 18:00</code>路
    鈳幆鈳幆鈳幆鈳幆鈳幆鈳幆鈳幆鈳幆鈳?    馃搳 <i>绗?2/2 椤?| 鍏?7 涓枃浠?/i>"

      131 |       const { text, buttons } = UIHelper.renderFilesPage(mockFiles, 1, 6, false);
      132 |
    > 133 |       expect(text).toContain('馃搫 <b>last.txt</b>\n> <code>0.00 MB</code> | <code>2023-01-07 18:00</code>');
          |                    ^
      134 |       expect(text).toContain("馃搳 <i>绗?2/2 椤?| 鍏?7 涓枃浠?/i>");
      135 |       expect(buttons[0][0].text).toBe('鈴笍'); // Home button enabled
      136 |       expect(buttons[0][1].text).toBe('猬咃笍');

      at Object.<anonymous> (__tests__/ui.test.js:133:20)

Test Suites: 7 failed, 7 passed, 14 total
Tests:       4 failed, 78 passed, 82 total
Snapshots:   0 total
Time:        2.509 s, estimated 3 s
Ran all test suites.
