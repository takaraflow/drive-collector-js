# Cloudflared Tunnel é…ç½®æŒ‡å—

## é—®é¢˜è¯Šæ–­

ä½ çš„é¡¹ç›®åœ¨å¼•å…¥s6-overlayå’Œcloudflaredåå‡ºç°é¢‘ç¹å…³é—­çš„é—®é¢˜ï¼ŒåŸå› æœ‰ä¸¤ä¸ªï¼š

### 1. s6-overlayé‡å¯é€»è¾‘é”™è¯¯ï¼ˆå·²ä¿®å¤âœ…ï¼‰
- finishè„šæœ¬æŠŠæ‰€æœ‰ä¿¡å·é€€å‡ºéƒ½å½“ä½œ"æ­£å¸¸ä¸é‡å¯"
- å¯¼è‡´åº”ç”¨å¼‚å¸¸å…³é—­åä¸é‡å¯ï¼ŒæœåŠ¡æ°¸ä¹…åœæ­¢
- **å·²åœ¨ `etc/s6-overlay/s6-rc.d/app/finish` ä¸­ä¿®å¤**

### 2. cloudflaredé…ç½®é—®é¢˜ï¼ˆéœ€è¦é€‰æ‹©ï¼‰âš ï¸

å½“å‰é…ç½®æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š
1. **appå¼ºåˆ¶ä¾èµ–cloudflared**ï¼šå¦‚æœcloudflaredæ²¡æœ‰æ­£å¸¸å¯åŠ¨ï¼Œappä¹Ÿæ— æ³•å¯åŠ¨
2. **åŒé‡ç®¡ç†å†²çª**ï¼šs6å’ŒNode.jséƒ½åœ¨å°è¯•ç®¡ç†tunnel

## Cloudflaredä½¿ç”¨æ–¹å¼

### æ–¹å¼Aï¼šå®Œå…¨ç¦ç”¨cloudflaredï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰

å¦‚æœä½ çš„åº”ç”¨å·²ç»æœ‰å…¬ç½‘IPæˆ–é€šè¿‡åå‘ä»£ç†è®¿é—®ï¼Œä¸éœ€è¦cloudflaredéš§é“ï¼š

**æ­¥éª¤1ï¼šç§»é™¤appå¯¹cloudflaredçš„ä¾èµ–**
```bash
# åˆ é™¤ä¾èµ–æ–‡ä»¶
rm etc/s6-overlay/s6-rc.d/app/dependencies.d/cloudflared
```

**æ­¥éª¤2ï¼šè®¾ç½®ç¯å¢ƒå˜é‡**
```bash
# åœ¨.envæˆ–Dockerç¯å¢ƒä¸­è®¾ç½®
TUNNEL_ENABLED=false
```

ç°åœ¨appä¼šç‹¬ç«‹å¯åŠ¨ï¼Œä¸ä¼šè¢«cloudflaredå½±å“ã€‚

---

### æ–¹å¼Bï¼šå¯ç”¨cloudflaredéš§é“ï¼ˆç”¨äºå¼€å‘/æµ‹è¯•ï¼‰

å¦‚æœä½ éœ€è¦ä¸´æ—¶çš„å…¬ç½‘URLï¼ˆæ¯”å¦‚æœ¬åœ°å¼€å‘ã€webhookæµ‹è¯•ï¼‰ï¼š

**æ­¥éª¤1ï¼šç¡®ä¿cloudflaredæœåŠ¡æ­£ç¡®é…ç½®**
```bash
# å½“å‰çš„runè„šæœ¬å·²ä¿®å¤ï¼Œä¼šåœ¨TUNNEL_ENABLED!=trueæ—¶æ­£å¸¸é€€å‡º
# æ— éœ€é¢å¤–ä¿®æ”¹
```

**æ­¥éª¤2ï¼šè®¾ç½®ç¯å¢ƒå˜é‡**
```bash
TUNNEL_ENABLED=true
PORT=7860  # ä½ çš„åº”ç”¨ç«¯å£
TUNNEL_METRICS_PORT=2000  # cloudflared metricsç«¯å£
```

**æ­¥éª¤3ï¼šè·å–éš§é“URL**

å¯åŠ¨åï¼ŒNode.jsçš„TunnelServiceä¼šè‡ªåŠ¨è½®è¯¢metricså¹¶è·å–URLï¼š
```javascript
// åœ¨ä»£ç ä¸­è·å–URL
const url = await tunnelService.getPublicUrl();
console.log('Public URL:', url);  // https://xxx-xxx-xxx.trycloudflare.com
```

---

## æ¨èé…ç½®ï¼ˆä¸¤ç§åœºæ™¯ï¼‰

### ç”Ÿäº§ç¯å¢ƒï¼š
```bash
# .env
TUNNEL_ENABLED=false

# ç§»é™¤ä¾èµ–
rm etc/s6-overlay/s6-rc.d/app/dependencies.d/cloudflared
```

### å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼š
```bash
# .env
TUNNEL_ENABLED=true
PORT=7860
TUNNEL_METRICS_PORT=2000

# ä¿ç•™ä¾èµ–å…³ç³»ï¼ˆç¡®ä¿cloudflaredå…ˆå¯åŠ¨ï¼‰
# etc/s6-overlay/s6-rc.d/app/dependencies.d/cloudflared ä¿ç•™
```

---

## è¯Šæ–­å·¥å…·

å¦‚æœé—®é¢˜ä»ç„¶å‘ç”Ÿï¼Œä½¿ç”¨è¯Šæ–­è„šæœ¬ï¼š

```bash
# åœ¨å®¹å™¨ä¸­è¿è¡Œ
docker exec -it <container_name> /etc/s6-overlay/scripts/diagnose-shutdown.sh
```

ä¼šæ˜¾ç¤ºï¼š
- Nodeè¿›ç¨‹çŠ¶æ€
- æ”¶åˆ°çš„ä¿¡å·
- s6æ—¥å¿—
- åº”ç”¨è¿è¡Œæ—¶é—´ï¼ˆå¦‚æœ<5åˆ†é’Ÿå°±å…³é—­ï¼Œé€šå¸¸æ˜¯é…ç½®é—®é¢˜ï¼‰

---

## å¿«é€Ÿä¿®å¤æ£€æŸ¥æ¸…å•

- [x] âœ… finishè„šæœ¬é‡å¯é€»è¾‘å·²ä¿®å¤
- [ ] âš ï¸ å†³å®šæ˜¯å¦éœ€è¦cloudflared
  - ä¸éœ€è¦ â†’ è®¾ç½® `TUNNEL_ENABLED=false` + ç§»é™¤ä¾èµ–
  - éœ€è¦ â†’ è®¾ç½® `TUNNEL_ENABLED=true` + ä¿ç•™ä¾èµ–
- [ ] ğŸ” æ£€æŸ¥å¹³å°å¥åº·æ£€æŸ¥é…ç½®ï¼ˆè¶…æ—¶æ—¶é—´ã€è·¯å¾„ï¼‰
- [ ] ğŸ” æ£€æŸ¥åº”ç”¨å¯åŠ¨æ—¶é—´ï¼ˆæ˜¯å¦åœ¨å¯åŠ¨å®Œæˆå‰å°±æ”¶åˆ°å¥åº·æ£€æŸ¥ï¼‰

---

## Cloudflaredå·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä½ çš„åº”ç”¨       â”‚
â”‚  localhost:7860 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ tunnel to
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  cloudflaredè¿›ç¨‹          â”‚
â”‚  - ç›‘å¬æœ¬åœ°7860ç«¯å£       â”‚
â”‚  - å»ºç«‹åˆ°Cloudflareçš„éš§é“ â”‚
â”‚  - æš´éœ²metrics:2000       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ é€šè¿‡Cloudflareç½‘ç»œ
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…¬ç½‘URL                    â”‚
â”‚  https://xxx.trycloudflare.com â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ³¨æ„**ï¼š
- å…è´¹çš„Quick Tunnelï¼ˆtrycloudflare.comï¼‰æ¯æ¬¡å¯åŠ¨URLéƒ½ä¼šå˜
- å¦‚æœéœ€è¦å›ºå®šURLï¼Œéœ€è¦é…ç½®Cloudflare Tunnelçš„è®¤è¯token
- ç”Ÿäº§ç¯å¢ƒä¸æ¨èä½¿ç”¨Quick Tunnel

---

## å¸¸è§é”™è¯¯

### âŒ é”™è¯¯1ï¼šappå¯åŠ¨è¶…æ—¶
**åŸå› **ï¼šcloudflaredæ²¡å¯åŠ¨ï¼Œä½†appä¾èµ–å®ƒ
**è§£å†³**ï¼šç§»é™¤ä¾èµ–æˆ–å¯ç”¨tunnel

### âŒ é”™è¯¯2ï¼šé¢‘ç¹æ”¶åˆ°SIGTERM
**åŸå› **ï¼šå¥åº·æ£€æŸ¥å¤±è´¥æˆ–åº”ç”¨å¯åŠ¨å¤ªæ…¢
**è§£å†³**ï¼š
1. å»¶é•¿å¥åº·æ£€æŸ¥è¶…æ—¶
2. æ£€æŸ¥åº”ç”¨å¯åŠ¨æ—¥å¿—
3. ä½¿ç”¨è¯Šæ–­è„šæœ¬è¿½è¸ªä¿¡å·æ¥æº

### âŒ é”™è¯¯3ï¼šè·å–ä¸åˆ°tunnel URL
**åŸå› **ï¼šmetricsç«¯å£æ²¡å¼€æˆ–cloudflaredæœªå°±ç»ª
**è§£å†³**ï¼š
1. ç­‰å¾…10-15ç§’è®©tunnelå»ºç«‹
2. æ£€æŸ¥ `http://localhost:2000/metrics` æ˜¯å¦å¯è®¿é—®
3. æŸ¥çœ‹cloudflaredæ—¥å¿—
